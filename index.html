<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no"/>
<title>SHEEPLY PERFECT TIMING</title>

<style>
  html,body{
    margin:0;height:100%;background:#070707;color:#fff;
    font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;
    overflow:hidden;
  }
  .app{position:relative;width:100%;height:100%;overflow:hidden}
  canvas{position:absolute;inset:0}

  .hud{
    position:absolute;top:16px;left:0;right:0;z-index:10;
    display:flex;justify-content:center;gap:18px;
    font-weight:950;letter-spacing:.6px; user-select:none;
    pointer-events:none;
  }
  .hud span{opacity:.82}

  .overlay{
    position:absolute;inset:0;z-index:20;
    display:grid;place-items:center;
    background:rgba(0,0,0,.65);
    backdrop-filter:blur(10px);
  }
  .panel{
    width:min(420px,92vw);
    border-radius:24px;
    border:1px solid rgba(255,255,255,.18);
    background:rgba(255,255,255,.07);
    box-shadow:0 18px 60px rgba(0,0,0,.55);
    padding:16px;
  }
  .btn{
    width:100%;
    padding:14px 18px;border-radius:18px;
    border:1px solid rgba(255,255,255,.20);
    background:rgba(255,255,255,.10);
    color:#fff;font-weight:950;letter-spacing:1px;
    cursor:pointer;
  }
  .btn:active{transform:translateY(1px) scale(.99)}
  .row{display:flex;gap:10px}
  .small{
    width:52px;min-width:52px;max-width:52px;
    padding:14px 0;border-radius:18px;
  }
  .flash{
    position:absolute;inset:0;
    background:#fff;
    opacity:0;
    pointer-events:none;
    transition: opacity 90ms linear;
    z-index:9;
  }

  /* promo modal */
  .promoOverlay{
    position:absolute;inset:0;z-index:30;
    display:none;place-items:center;
    background:rgba(0,0,0,.70);
    backdrop-filter:blur(10px);
  }
  .codeBox{
    margin-top:12px;
    border-radius:18px;
    border:1px dashed rgba(255,255,255,.28);
    background:rgba(0,0,0,.25);
    padding:12px 12px;
    display:flex;align-items:center;justify-content:space-between;gap:10px;
    font-weight:950;letter-spacing:1px;
  }
  .muted{opacity:.72;font-size:12px;letter-spacing:.2px}
</style>
</head>

<body>
<div class="app">
  <canvas id="c"></canvas>

  <div class="hud">
    <span id="score">0</span>
    <span id="combo">Ã—0</span>
  </div>

  <div class="overlay" id="ov">
    <div class="panel">
      <button class="btn" id="play">PLAY</button>
      <div class="muted" style="margin-top:10px;display:flex;justify-content:space-between">
        <span>tap</span><span>noir</span>
      </div>
    </div>
  </div>

  <div class="promoOverlay" id="promoOv">
    <div class="panel">
      <div style="font-weight:950;letter-spacing:.9px">ðŸŽ‰</div>
      <div class="muted" style="margin-top:6px">PROMO</div>

      <div class="codeBox">
        <span id="promoText">SHEEPLYGAME5</span>
        <button class="btn small" id="copyBtn" title="copy">â§‰</button>
      </div>

      <div class="muted" style="margin-top:10px">5% OFF</div>
      <div class="row" style="margin-top:12px">
        <button class="btn" id="continueBtn">OK</button>
      </div>
    </div>
  </div>

  <div class="flash" id="flash"></div>
</div>

<script>
(() => {
  const TG = window.Telegram?.WebApp;
  try { TG?.ready(); TG?.expand(); } catch(e) {}

  const PROMO_CODE = "SHEEPLYGAME5";
  const PROMO_COMBO = 100;

  const canvas = document.getElementById("c");
  const ctx = canvas.getContext("2d");
  const flash = document.getElementById("flash");

  const scoreEl = document.getElementById("score");
  const comboEl = document.getElementById("combo");
  const ov = document.getElementById("ov");

  const promoOv = document.getElementById("promoOv");
  const copyBtn = document.getElementById("copyBtn");
  const continueBtn = document.getElementById("continueBtn");

  // --- Logo ---
  const logo = new Image();
  logo.src = "SHEEPLY_02-2-negate-Photoroom.png";
  let logoReady = false;
  logo.onload = () => (logoReady = true);

  let W=0, H=0, dpr=1;
  function resize(){
    dpr = Math.min(2, window.devicePixelRatio || 1);
    W = Math.floor(window.innerWidth * dpr);
    H = Math.floor(window.innerHeight * dpr);
    canvas.width = W; canvas.height = H;
    canvas.style.width = window.innerWidth + "px";
    canvas.style.height = window.innerHeight + "px";
  }
  window.addEventListener("resize", resize, {passive:true});
  resize();

  let running=false;
  let angle=0;
  let speed=0.038; // base speed a bit higher

  let score=0;
  let combo=0;

  // zone size is now dynamic (radians)
  let zoneSize = 0.35;

  // promo only once per run
  let promoShown = false;

  function ringR(){ return Math.min(W,H) * 0.25; }

  function rand(a,b){ return a + Math.random()*(b-a); }

  function randomizeZone(){
    // random range: easier early, tighter later (based on combo)
    const c = Math.min(120, combo);
    const t = c / 120; // 0..1
    const max = 0.40 - t*0.14; // 0.40 -> 0.26
    const min = 0.18 - t*0.06; // 0.18 -> 0.12
    zoneSize = rand(min, max);
  }

  function start(){
    running=true;
    angle=0;
    speed=0.038;
    score=0;
    combo=0;
    promoShown=false;
    randomizeZone();
    ov.style.display="none";
    promoOv.style.display="none";
    try{ TG?.HapticFeedback?.impactOccurred?.('light'); }catch(e){}
  }
  document.getElementById("play").addEventListener("click", start);

  function showPromo(){
    promoShown = true;
    promoOv.style.display = "grid";
    try{ TG?.HapticFeedback?.notificationOccurred?.('success'); }catch(e){}
    // optional: notify bot
    try{
      TG?.sendData?.(JSON.stringify({game:"sheeply_perfect_timing", event:"promo_unlocked", code:PROMO_CODE, combo, score, ts:Date.now()}));
    }catch(e){}
  }

  copyBtn.addEventListener("click", async ()=>{
    try{
      await navigator.clipboard.writeText(PROMO_CODE);
      flash.style.opacity = "0.18";
      setTimeout(()=>flash.style.opacity="0", 110);
      try{ TG?.HapticFeedback?.impactOccurred?.('light'); }catch(e){}
    }catch(e){
      // clipboard may be blocked; still ok
    }
  });

  continueBtn.addEventListener("click", ()=>{
    promoOv.style.display="none";
  });

  // Tap = check timing
  canvas.addEventListener("pointerdown", ()=>{
    if(!running) return;
    if(promoOv.style.display !== "none") return; // ignore taps while promo open

    const a = (angle % (Math.PI*2) + Math.PI*2) % (Math.PI*2);
    const target = Math.PI*1.5; // 12 o'clock
    let diff = Math.abs(target - a);
    diff = Math.min(diff, Math.PI*2 - diff);

    if(diff < zoneSize){
      // HIT
      combo++;

      const precision = (zoneSize - diff) / zoneSize; // 0..1
      const bonus = Math.max(10, Math.floor(10 + precision * 80));
      score += Math.floor(bonus * (1 + combo*0.18));

      // speed grows a bit faster now
      speed += 0.0042;

      // randomize zone each successful hit (keeps it spicy)
      randomizeZone();

      flash.style.opacity = "0.25";
      setTimeout(()=>flash.style.opacity="0", 90);

      try{ TG?.HapticFeedback?.notificationOccurred?.('success'); }catch(e){}

      if(!promoShown && combo >= PROMO_COMBO){
        showPromo();
      }
    } else {
      // MISS
      combo = 0;
      speed = Math.max(0.03, speed - 0.012);
      randomizeZone();
      try{ TG?.HapticFeedback?.impactOccurred?.('heavy'); }catch(e){}
    }
  }, {passive:true});

  function draw(){
    ctx.clearRect(0,0,W,H);
    const cx=W/2, cy=H/2;
    const R = ringR();

    // background vignette
    const vg = ctx.createRadialGradient(cx, cy, R*0.4, cx, cy, R*2.2);
    vg.addColorStop(0, "rgba(255,255,255,.03)");
    vg.addColorStop(1, "rgba(0,0,0,1)");
    ctx.fillStyle = vg;
    ctx.fillRect(0,0,W,H);

    // ring
    ctx.lineWidth = 6*dpr;
    ctx.strokeStyle = "rgba(255,255,255,.22)";
    ctx.beginPath();
    ctx.arc(cx, cy, R, 0, Math.PI*2);
    ctx.stroke();

    // perfect zone (dynamic)
    ctx.strokeStyle = "rgba(255,255,255,.88)";
    ctx.beginPath();
    ctx.arc(cx, cy, R, (Math.PI*1.5 - zoneSize), (Math.PI*1.5 + zoneSize));
    ctx.stroke();

    // logo in center (clipped)
    if(logoReady){
      ctx.save();
      ctx.beginPath();
      ctx.arc(cx, cy, R * 0.55, 0, Math.PI*2);
      ctx.clip();

      const pulse = 0.96 + Math.sin(Date.now() / 420) * 0.03;
      const size = R * 1.05 * pulse;

      ctx.globalAlpha = 0.90;
      ctx.drawImage(logo, cx - size/2, cy - size/2, size, size);
      ctx.restore();
    }

    // dot
    const x=cx + Math.cos(angle)*R;
    const y=cy + Math.sin(angle)*R;
    ctx.fillStyle="#fff";
    ctx.beginPath();
    ctx.arc(x,y,6*dpr,0,Math.PI*2);
    ctx.fill();

    scoreEl.textContent = String(score);
    comboEl.textContent = "Ã—" + String(combo);
  }

  function loop(){
    if(running){
      angle += speed;
    }
    draw();
    requestAnimationFrame(loop);
  }
  loop();
})();
</script>
</body>
</html>
