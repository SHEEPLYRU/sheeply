<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <title>SHEEPLY Sleep ‚Äì —Å—á–∏—Ç–∞–π –æ–≤–µ—Ü</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1" />
  <meta name="theme-color" content="#bde0ff" />
  <!-- –®—Ä–∏—Ñ—Ç—ã: –ø–∏–∫—Å–µ–ª—å–Ω—ã–π –¥–ª—è —Å—á—ë—Ç–∞ + —Å–æ–≤—Ä–µ–º–µ–Ω–Ω—ã–π –¥–ª—è —Ç–µ–∫—Å—Ç–∞ -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Press+Start+2P&family=Inter:wght@400;600&display=swap" rel="stylesheet">
  <style>
    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
      -webkit-tap-highlight-color: transparent;
    }

    body {
      background: #bde0ff;
      font-family: "Inter", system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      color: #0f172a;
      overflow: hidden;
    }

    #app {
      max-width: 480px;
      margin: 0 auto;
      height: 100vh;
      display: flex;
      flex-direction: column;
      padding: 10px;
      gap: 8px;
    }

    #header {
      flex-shrink: 0;
      padding: 10px 14px;
      border-radius: 18px;
      background: linear-gradient(145deg, #ffffff, #e0f2ff);
      box-shadow: 0 10px 25px rgba(15, 23, 42, 0.25);
      display: flex;
      flex-direction: column;
      gap: 6px;
    }

    #title {
      font-family: "Press Start 2P", system-ui, sans-serif;
      font-size: 12px;
      letter-spacing: 0.08em;
      text-transform: uppercase;
      color: #0f172a;
    }

    #subtitle {
      font-size: 12px;
      color: #4b5563;
    }

    #stats {
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
      margin-top: 6px;
    }

    .pill {
      font-family: "Press Start 2P", system-ui, sans-serif;
      font-size: 9px;
      padding: 4px 8px;
      border-radius: 999px;
      background: rgba(148, 163, 184, 0.16);
      display: inline-flex;
      align-items: center;
      gap: 4px;
      color: #0f172a;
    }

    #gameCard {
      flex: 1;
      min-height: 0;
      border-radius: 22px;
      background: #bde0ff;
      box-shadow: 0 16px 40px rgba(15, 23, 42, 0.45);
      overflow: hidden;
      display: flex;
      flex-direction: column;
      position: relative;
    }

    #canvasWrapper {
      flex: 1;
      position: relative;
      overflow: hidden;
    }

    #gameCanvas {
      display: block;
      width: 100%;
      height: 100%;
      touch-action: manipulation;
      image-rendering: pixelated;
    }

    #hint {
      position: absolute;
      bottom: 10px;
      left: 50%;
      transform: translateX(-50%);
      padding: 4px 10px;
      border-radius: 999px;
      font-size: 11px;
      background: rgba(15, 23, 42, 0.6);
      color: #f9fafb;
      display: inline-flex;
      align-items: center;
      gap: 4px;
      backdrop-filter: blur(12px);
      border: 1px solid rgba(191, 219, 254, 0.9);
    }

    #footer {
      flex-shrink: 0;
      margin-top: 4px;
      font-size: 11px;
      text-align: center;
      color: #64748b;
    }

    @media (max-width: 400px) {
      #title { font-size: 10px; }
      .pill { font-size: 8px; }
    }
  </style>
</head>
<body>
  <!-- –ï—Å–ª–∏ –Ω—É–∂–Ω–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å Telegram WebApp API, –ø—Ä–æ—Å—Ç–æ –¥–æ–±–∞–≤—å:
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  –∏ –∏—Å–ø–æ–ª—å–∑—É–π window.Telegram.WebApp –≤–Ω—É—Ç—Ä–∏ JS -->
  <div id="app">
    <header id="header">
      <div id="title">SHEEPLY ‚Äì COUNT SHEEP</div>
      <div id="subtitle">–¢–∞–ø–∞–π –ø–æ –æ–≤–µ—á–∫–µ, —Å—á–∏—Ç–∞–π –æ–≤–µ—Ü –ø–µ—Ä–µ–¥ —Å–Ω–æ–º. –ß–µ–º –±–æ–ª—å—à–µ –æ–≤–µ—Ü, —Ç–µ–º —Ç–µ–º–Ω–µ–µ –Ω–µ–±–æ üåô</div>
      <div id="stats">
        <span class="pill">–û–í–¶–´: <span id="scoreValue">0</span></span>
        <span class="pill">–†–ï–ö–û–†–î: <span id="bestValue">0</span></span>
        <span class="pill">–ö–û–ú–ë–û: <span id="comboValue">0</span></span>
      </div>
    </header>

    <main id="gameCard">
      <div id="canvasWrapper">
        <canvas id="gameCanvas"></canvas>
        <div id="hint">–ù–∞–∂–∏–º–∞–π –Ω–∞ –æ–≤—Ü—É üêë, —á—Ç–æ–±—ã –¥–æ–±–∞–≤–∏—Ç—å –µ—â—ë –æ–¥–Ω—É –≤ —Å—á—ë—Ç</div>
      </div>
      <div id="footer">–ú—è–≥–∫–∞—è –ø–∏–∫—Å–µ–ª—å–Ω–∞—è —Ñ–µ—Ä–º–∞ –±–µ–∑ —Ç–∞–π–º–µ—Ä–æ–≤ –∏ —Ä–µ–∫–ª–∞–º—ã ‚Äî —Ç–æ–ª—å–∫–æ —Ç—ã –∏ –æ–≤–µ—á–∫–∏.</div>
    </main>
  </div>

  <script>
    const canvas = document.getElementById("gameCanvas");
    const ctx = canvas.getContext("2d");

    const scoreEl = document.getElementById("scoreValue");
    const bestEl = document.getElementById("bestValue");
    const comboEl = document.getElementById("comboValue");
    const hintEl = document.getElementById("hint");

    let w = 0, h = 0;

    const state = {
      score: 0,
      best: 0,
      combo: 0,
      jumpTime: 0,
      jumpDuration: 260,
      wavePhase: 0,
      sheep: { x: 0, y: 0, size: 80 },
      zzz: [] // –º–∞—Å—Å–∏–≤ "Zzz"-—á–∞—Å—Ç–∏—Ü
    };

    // —á–∏—Ç–∞–µ–º —Ä–µ–∫–æ—Ä–¥
    try {
      const saved = localStorage.getItem("sheep_sleep_best");
      if (saved) {
        state.best = parseInt(saved, 10) || 0;
      }
    } catch (_) {}
    bestEl.textContent = state.best;

    function resizeCanvas() {
      const rect = canvas.getBoundingClientRect();
      const dpr = window.devicePixelRatio || 1;
      canvas.width = rect.width * dpr;
      canvas.height = rect.height * dpr;
      ctx.setTransform(dpr, 0, 0, dpr, 0, 0);
      w = rect.width;
      h = rect.height;

      // –ø–æ–∑–∏—Ü–∏—è –æ–≤—Ü—ã –Ω–µ–º–Ω–æ–≥–æ –≤—ã—à–µ —Ü–µ–Ω—Ç—Ä–∞
      state.sheep.size = Math.min(w, h) * 0.23;
      state.sheep.x = w / 2;
      state.sheep.y = h * 0.6;
    }

    window.addEventListener("resize", resizeCanvas);

    function updateScoreViews() {
      scoreEl.textContent = state.score;
      bestEl.textContent = state.best;
      comboEl.textContent = state.combo;
    }

    // –ª–æ–≥–∏–∫–∞ "—Ç–∞–ø –ø–æ –æ–≤—Ü–µ"
    function handleTap(isAuto = false) {
      if (!isAuto) hintEl.style.display = "none";

      state.score += 1;
      state.combo += 1;
      if (state.score > state.best) {
        state.best = state.score;
        try {
          localStorage.setItem("sheep_sleep_best", String(state.best));
        } catch (_) {}
      }
      state.jumpTime = state.jumpDuration; // –∑–∞–ø—É—Å–∫–∞–µ–º –ø—Ä—ã–∂–æ–∫
      spawnZzz();
      updateScoreViews();
    }

    function isPointInSheep(x, y) {
      const dx = x - state.sheep.x;
      const dy = y - state.sheep.y;
      const r = state.sheep.size * 0.7;
      return dx * dx + dy * dy <= r * r;
    }

    canvas.addEventListener("click", (e) => {
      const rect = canvas.getBoundingClientRect();
      const x = e.clientX - rect.left;
      const y = e.clientY - rect.top;
      if (isPointInSheep(x, y)) {
        handleTap(false);
      } else {
        // –ø—Ä–æ–º–∞—Ö –ø–æ –æ–≤—Ü–µ –Ω–µ –Ω–∞–∫–∞–∑—ã–≤–∞–µ—Ç, –ø—Ä–æ—Å—Ç–æ —Å–±—Ä–∞—Å—ã–≤–∞–µ–º –∫–æ–º–±–æ –Ω–µ–∂–Ω–æ
        state.combo = 0;
        comboEl.textContent = "0";
      }
    });

    canvas.addEventListener("touchstart", (e) => {
      const t = e.touches[0];
      const rect = canvas.getBoundingClientRect();
      const x = t.clientX - rect.left;
      const y = t.clientY - rect.top;
      if (isPointInSheep(x, y)) {
        handleTap(false);
      } else {
        state.combo = 0;
        comboEl.textContent = "0";
      }
    }, { passive: true });

    // Zzz-—á–∞—Å—Ç–∏—Ü—ã
    function spawnZzz() {
      state.zzz.push({
        x: state.sheep.x + (Math.random() - 0.5) * state.sheep.size * 0.5,
        y: state.sheep.y - state.sheep.size * 0.7,
        age: 0,
        life: 1200 + Math.random() * 600,
        char: Math.random() < 0.5 ? "Z" : "z",
        speedY: -0.03 - Math.random() * 0.03
      });
    }

    function updateZzz(dt) {
      for (let i = state.zzz.length - 1; i >= 0; i--) {
        const z = state.zzz[i];
        z.age += dt;
        z.y += z.speedY * dt;
        if (z.age > z.life) {
          state.zzz.splice(i, 1);
        }
      }
    }

    function drawZzz() {
      ctx.save();
      ctx.font = `${Math.round(state.sheep.size * 0.3)}px "Press Start 2P"`;
      ctx.textAlign = "center";
      ctx.textBaseline = "middle";
      for (const z of state.zzz) {
        const alpha = 1 - z.age / z.life;
        ctx.globalAlpha = Math.max(0, alpha);
        ctx.fillStyle = "#ffffff";
        ctx.fillText(z.char, z.x, z.y);
      }
      ctx.restore();
    }

    // –§–æ–Ω: –Ω–µ–±–æ + –æ–±–ª–∞–∫–∞ + –≥—Ä–∞–¥–∏–µ–Ω—Ç –Ω–æ—á—å/–¥–µ–Ω—å
    function drawBackground() {
      const progressToNight = Math.min(state.score / 40, 1); // —á–µ–º –±–æ–ª—å—à–µ –æ–≤–µ—Ü, —Ç–µ–º —Ç–µ–º–Ω–µ–µ –¥–æ "–Ω–æ—á–∏"

      const topColorDay = { r: 189, g: 224, b: 255 }; // #bde0ff
      const topColorNight = { r: 15, g: 23, b: 42 };  // #0f172a

      function lerp(a, b, t) { return a + (b - a) * t; }

      const r = Math.round(lerp(topColorDay.r, topColorNight.r, progressToNight));
      const g = Math.round(lerp(topColorDay.g, topColorNight.g, progressToNight));
      const b = Math.round(lerp(topColorDay.b, topColorNight.b, progressToNight));

      const skyTop = `rgb(${r},${g},${b})`;
      const skyBottom = progressToNight < 0.7 ? "#ffffff" : "#cbd5f5";

      const grad = ctx.createLinearGradient(0, 0, 0, h);
      grad.addColorStop(0, skyTop);
      grad.addColorStop(1, skyBottom);
      ctx.fillStyle = grad;
      ctx.fillRect(0, 0, w, h);

      // –ø—Ä–æ—Å—Ç—ã–µ –ø–∏–∫—Å–µ–ª—å–Ω—ã–µ –æ–±–ª–∞–∫–∞
      const cloudColor = `rgba(255,255,255,${1 - progressToNight * 0.5})`;
      ctx.fillStyle = cloudColor;

      const t = state.wavePhase * 0.001;
      drawPixelCloud(w * 0.2 + Math.sin(t) * 15, h * 0.2, 40);
      drawPixelCloud(w * 0.7 + Math.cos(t * 0.7) * 25, h * 0.15, 50);

      // –ª—É–Ω–∞ –ø–æ—è–≤–ª—è–µ—Ç—Å—è –±–ª–∏–∂–µ –∫ –Ω–æ—á–∏
      if (progressToNight > 0.3) {
        const moonAlpha = (progressToNight - 0.3) / 0.7;
        ctx.save();
        ctx.globalAlpha = moonAlpha;
        ctx.beginPath();
        ctx.arc(w * 0.85, h * 0.15, 14, 0, Math.PI * 2);
        ctx.fillStyle = "#fefce8";
        ctx.fill();
        ctx.restore();
      }

      // —Ç—Ä–∞–≤–∫–∞/–ø–æ–ª
      ctx.fillStyle = "#e0f7ff";
      ctx.fillRect(0, h * 0.7, w, h * 0.3);
      ctx.fillStyle = "#ffffff";
      for (let x = 0; x < w; x += 8) {
        ctx.fillRect(x, h * 0.7 + ((x / 8) % 2) * 4, 8, 4);
      }

      // –∑–∞–±–æ—Ä
      const fenceY = h * 0.7 - 20;
      ctx.fillStyle = "#cbd5e1";
      ctx.fillRect(0, fenceY, w, 6);
      ctx.fillStyle = "#94a3b8";
      ctx.fillRect(0, fenceY + 6, w, 3);
      ctx.fillStyle = "#e5e7eb";
      for (let x = 10; x < w; x += 28) {
        ctx.fillRect(x, fenceY - 18, 6, 24);
      }
    }

    function drawPixelCloud(cx, cy, size) {
      const unit = size / 8;
      const blocks = [
        { x: 0, y: 2, w: 8, h: 3 },
        { x: 1, y: 1, w: 6, h: 2 },
        { x: 2, y: 0, w: 4, h: 1 },
        { x: 2, y: 5, w: 4, h: 1 }
      ];
      blocks.forEach(b => {
        ctx.fillRect(
          cx + (b.x - 4) * unit,
          cy + (b.y - 3) * unit,
          b.w * unit,
          b.h * unit
        );
      });
    }

    // –ü–∏–∫—Å–µ–ª—å–Ω–∞—è –æ–≤—Ü–∞
    function drawSheep() {
      const s = state.sheep;
      const baseSize = s.size;
      const unit = baseSize / 8;

      // –ª–µ–≥–∫–∏–π –ø—Ä—ã–∂–æ–∫
      let offsetY = 0;
      if (state.jumpTime > 0) {
        const t = 1 - state.jumpTime / state.jumpDuration; // 0..1
        offsetY = -Math.sin(t * Math.PI) * unit * 2.5;
      }

      const cx = s.x;
      const cy = s.y + offsetY;

      // —Ç–µ–Ω—å
      ctx.save();
      ctx.globalAlpha = 0.3;
      ctx.beginPath();
      ctx.ellipse(cx, cy + unit * 4.5, unit * 4, unit * 1.7, 0, 0, Math.PI * 2);
      ctx.fillStyle = "#94a3b8";
      ctx.fill();
      ctx.restore();

      // —Ç–µ–ª–æ
      ctx.fillStyle = "#f9fafb";
      ctx.fillRect(cx - unit * 3, cy - unit * 2, unit * 6, unit * 4);
      ctx.fillStyle = "#e5e7eb";
      ctx.fillRect(cx - unit * 3, cy - unit, unit, unit * 2);
      ctx.fillRect(cx + unit * 2, cy - unit, unit, unit * 2);
      ctx.fillRect(cx - unit * 2, cy - unit * 2.4, unit * 4, unit * 1.2);

      // –≥–æ–ª–æ–≤–∞
      ctx.fillStyle = "#111827";
      ctx.fillRect(cx + unit * 3, cy - unit * 1.5, unit * 2.1, unit * 3);
      ctx.fillStyle = "#e5e7eb";
      ctx.fillRect(cx + unit * 3, cy - unit, unit * 1.2, unit * 2);

      // –≥–ª–∞–∑–∞
      ctx.fillStyle = "#000000";
      ctx.fillRect(cx + unit * 3.3, cy - unit * 0.6, unit * 0.6, unit * 0.6);
      ctx.fillRect(cx + unit * 3.9, cy - unit * 0.6, unit * 0.6, unit * 0.6);

      // –Ω–æ–∂–∫–∏
      ctx.fillStyle = "#111827";
      ctx.fillRect(cx - unit * 2.2, cy + unit * 2, unit * 0.9, unit * 2.4);
      ctx.fillRect(cx - unit * 0.5, cy + unit * 2, unit * 0.9, unit * 2.4);
      ctx.fillRect(cx + unit * 1.2, cy + unit * 2, unit * 0.9, unit * 2.4);
    }

    function step(timestamp) {
      if (!state.lastTs) state.lastTs = timestamp;
      const dt = timestamp - state.lastTs;
      state.lastTs = timestamp;

      state.wavePhase += dt;
      if (state.jumpTime > 0) {
        state.jumpTime -= dt;
        if (state.jumpTime < 0) state.jumpTime = 0;
      }

      updateZzz(dt);

      ctx.clearRect(0, 0, w, h);
      drawBackground();
      drawSheep();
      drawZzz();

      requestAnimationFrame(step);
    }

    // init
    resizeCanvas();
    updateScoreViews();
    requestAnimationFrame(step);
  </script>
</body>
</html>
