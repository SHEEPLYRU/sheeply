<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no" />
  <title>Neon Tap ‚Äî Telegram WebApp</title>
  <style>
    :root{
      --bg0:#070A12;
      --bg1:#0A0F22;
      --glass: rgba(255,255,255,.08);
      --glass2: rgba(255,255,255,.12);
      --txt: rgba(255,255,255,.92);
      --muted: rgba(255,255,255,.62);
      --good:#62f6ff;
      --hot:#ff4fd8;
      --warn:#ffd166;
      --bad:#ff3b5c;
      --shadow: 0 18px 60px rgba(0,0,0,.45);
      --r: 24px;
    }
    *{box-sizing:border-box}
    html,body{height:100%;margin:0;background:radial-gradient(1200px 700px at 20% 10%, #1a1f46 0%, rgba(26,31,70,0) 55%),
                             radial-gradient(900px 600px at 85% 20%, #3d1451 0%, rgba(61,20,81,0) 55%),
                             linear-gradient(180deg, var(--bg0), var(--bg1));
              color:var(--txt); font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; overflow:hidden;}
    a{color:inherit}
    .wrap{height:100%;display:grid;place-items:center;padding:14px;}
    .app{
      width:min(520px, 100%);
      height:min(900px, 100%);
      border-radius: clamp(18px, 3vw, 30px);
      background: linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.03));
      box-shadow: var(--shadow);
      border: 1px solid rgba(255,255,255,.10);
      backdrop-filter: blur(10px);
      overflow:hidden;
      position:relative;
    }
    canvas#fx{position:absolute;inset:0;z-index:1;}
    .ui{position:relative;z-index:2;height:100%;display:flex;flex-direction:column;}
    header{
      display:flex;align-items:center;justify-content:space-between;
      padding:14px 16px 10px;
      gap:10px;
    }
    .brand{display:flex;gap:10px;align-items:center}
    .logo{
      width:40px;height:40px;border-radius:14px;
      background: radial-gradient(circle at 30% 30%, rgba(98,246,255,.9), rgba(255,79,216,.85));
      box-shadow: 0 0 0 1px rgba(255,255,255,.14), 0 18px 40px rgba(255,79,216,.18);
      position:relative;
      overflow:hidden;
    }
    .logo:after{
      content:""; position:absolute; inset:-30%;
      background: conic-gradient(from 180deg, rgba(255,255,255,0), rgba(255,255,255,.35), rgba(255,255,255,0));
      animation: spin 3.2s linear infinite;
    }
    @keyframes spin{to{transform:rotate(360deg)}}
    .title{line-height:1.05}
    .title b{display:block;font-size:14px;letter-spacing:.2px}
    .title span{display:block;font-size:12px;color:var(--muted)}
    .pill{
      display:flex;gap:10px;align-items:center;
      background: rgba(255,255,255,.06);
      border: 1px solid rgba(255,255,255,.10);
      border-radius: 999px;
      padding:8px 10px;
    }
    .mini{
      display:flex;flex-direction:column;gap:2px;min-width:72px;text-align:right
    }
    .mini .k{font-size:11px;color:var(--muted)}
    .mini .v{font-weight:700;font-size:14px}
    .btn{
      border:none;cursor:pointer;color:var(--txt);
      padding:10px 12px;border-radius:14px;
      background: linear-gradient(180deg, rgba(255,255,255,.10), rgba(255,255,255,.05));
      border:1px solid rgba(255,255,255,.12);
      box-shadow: 0 12px 30px rgba(0,0,0,.2);
      transition: transform .08s ease, filter .15s ease;
      user-select:none;
    }
    .btn:active{transform: translateY(1px) scale(.99); filter:brightness(1.05);}
    .btn.primary{
      background: radial-gradient(circle at 30% 20%, rgba(98,246,255,.35), rgba(255,79,216,.25)) ,
                  linear-gradient(180deg, rgba(255,255,255,.12), rgba(255,255,255,.05));
      border-color: rgba(98,246,255,.25);
    }
    .content{flex:1;display:flex;flex-direction:column;gap:12px;padding:0 16px 16px;}
    .card{
      background: rgba(255,255,255,.06);
      border:1px solid rgba(255,255,255,.10);
      border-radius: var(--r);
      box-shadow: 0 14px 40px rgba(0,0,0,.25);
      overflow:hidden;
    }
    .stats{
      display:grid;grid-template-columns:1fr 1fr 1fr;gap:10px;padding:12px;
    }
    .stat{
      background: rgba(0,0,0,.14);
      border:1px solid rgba(255,255,255,.08);
      border-radius: 18px;
      padding:10px;
    }
    .stat .k{font-size:11px;color:var(--muted)}
    .stat .v{font-size:18px;font-weight:800;margin-top:4px}
    .bar{
      height:8px;border-radius:999px;
      background: rgba(255,255,255,.07); margin-top:8px; overflow:hidden;
      border:1px solid rgba(255,255,255,.08);
    }
    .bar > i{display:block;height:100%;width:30%;
      background: linear-gradient(90deg, rgba(98,246,255,.9), rgba(255,79,216,.9));
      box-shadow: 0 0 20px rgba(255,79,216,.35);
    }
    .arenaWrap{flex:1; display:flex; flex-direction:column; gap:12px;}
    .arena{
      position:relative;
      height: clamp(360px, 54vh, 560px);
      border-radius: var(--r);
      background:
        radial-gradient(600px 300px at 50% 10%, rgba(98,246,255,.14), rgba(98,246,255,0) 60%),
        radial-gradient(600px 300px at 40% 90%, rgba(255,79,216,.12), rgba(255,79,216,0) 60%),
        linear-gradient(180deg, rgba(0,0,0,.22), rgba(0,0,0,.10));
      border:1px solid rgba(255,255,255,.10);
      overflow:hidden;
      touch-action: manipulation;
    }
    .grid{
      position:absolute; inset:-20%;
      background-image:
        radial-gradient(circle at 50% 50%, rgba(255,255,255,.06) 0 1px, rgba(0,0,0,0) 2px),
        linear-gradient(90deg, rgba(255,255,255,.04) 1px, transparent 1px),
        linear-gradient(0deg, rgba(255,255,255,.04) 1px, transparent 1px);
      background-size: 30px 30px, 90px 90px, 90px 90px;
      transform: rotate(8deg);
      opacity:.35;
      filter: blur(.2px);
      pointer-events:none;
    }
    .hint{
      position:absolute; left:14px; right:14px; top:12px;
      display:flex; justify-content:space-between; align-items:center; gap:10px;
      font-size:12px; color:var(--muted);
      pointer-events:none;
    }
    .hint b{color:var(--txt)}
    .ring{
      position:absolute; width:112px; height:112px;
      border-radius: 999px;
      display:grid; place-items:center;
      transform: translate(-50%,-50%);
      cursor:pointer;
      user-select:none;
      will-change: transform, opacity;
      filter: drop-shadow(0 14px 26px rgba(0,0,0,.35));
    }
    .ring .core{
      width:70px;height:70px;border-radius:999px;
      background: radial-gradient(circle at 30% 30%, rgba(255,255,255,.40), rgba(255,255,255,.06));
      border: 1px solid rgba(255,255,255,.20);
      box-shadow:
        0 0 0 10px rgba(98,246,255,.10),
        0 0 0 20px rgba(255,79,216,.07),
        0 0 40px rgba(98,246,255,.22),
        inset 0 0 20px rgba(255,255,255,.12);
      display:grid;place-items:center;
      font-weight:900;
      letter-spacing:.3px;
    }
    .ring.good .core{box-shadow:
        0 0 0 10px rgba(98,246,255,.10),
        0 0 0 20px rgba(98,246,255,.06),
        0 0 40px rgba(98,246,255,.28),
        inset 0 0 20px rgba(255,255,255,.12);
    }
    .ring.hot .core{box-shadow:
        0 0 0 10px rgba(255,79,216,.10),
        0 0 0 20px rgba(255,79,216,.06),
        0 0 44px rgba(255,79,216,.26),
        inset 0 0 20px rgba(255,255,255,.12);
    }
    .ring.warn .core{box-shadow:
        0 0 0 10px rgba(255,209,102,.11),
        0 0 0 20px rgba(255,209,102,.07),
        0 0 40px rgba(255,209,102,.20),
        inset 0 0 20px rgba(255,255,255,.12);
    }
    .ring.bad .core{
      background: radial-gradient(circle at 30% 30%, rgba(255,255,255,.24), rgba(255,255,255,.05));
      border-color: rgba(255,255,255,.16);
      box-shadow:
        0 0 0 10px rgba(255,59,92,.12),
        0 0 0 20px rgba(255,59,92,.07),
        0 0 44px rgba(255,59,92,.22),
        inset 0 0 20px rgba(255,255,255,.10);
    }

    .footer{
      display:flex; gap:10px; align-items:center; justify-content:space-between;
      padding:12px;
    }
    .footer .left{display:flex;gap:10px;align-items:center}
    .toggle{
      display:flex;align-items:center;gap:8px;
      font-size:12px;color:var(--muted);
      padding:8px 10px;border-radius:999px;
      background: rgba(255,255,255,.06);
      border:1px solid rgba(255,255,255,.10);
      user-select:none;
    }
    .dot{
      width:10px;height:10px;border-radius:999px;background: rgba(255,255,255,.25);
      box-shadow: 0 0 16px rgba(98,246,255,.0);
      transition: all .2s ease;
    }
    .toggle.on .dot{background: rgba(98,246,255,.85); box-shadow: 0 0 16px rgba(98,246,255,.35);}
    .overlay{
      position:absolute; inset:0; z-index:3;
      display:grid; place-items:center;
      background: radial-gradient(700px 450px at 50% 25%, rgba(255,255,255,.10), rgba(0,0,0,.32) 65%),
                  rgba(0,0,0,.25);
      backdrop-filter: blur(10px);
      padding:18px;
    }
    .modal{
      width:min(420px, 100%);
      border-radius: 26px;
      background: rgba(255,255,255,.08);
      border:1px solid rgba(255,255,255,.12);
      box-shadow: var(--shadow);
      padding:16px;
    }
    .modal h1{font-size:18px;margin:0 0 6px}
    .modal p{margin:0 0 12px;color:var(--muted);font-size:13px;line-height:1.35}
    .row{display:flex;gap:10px;flex-wrap:wrap}
    .row .btn{flex:1}
    .tiny{font-size:11px;color:rgba(255,255,255,.50);margin-top:10px}
    .shake{animation: shake .18s linear 1}
    @keyframes shake{
      0%{transform:translateX(0)}
      25%{transform:translateX(-3px)}
      50%{transform:translateX(3px)}
      75%{transform:translateX(-2px)}
      100%{transform:translateX(0)}
    }
  </style>
</head>
<body>
<div class="wrap">
  <div class="app" id="app">
    <canvas id="fx"></canvas>

    <div class="ui">
      <header>
        <div class="brand">
          <div class="logo" aria-hidden="true"></div>
          <div class="title">
            <b>Neon Tap</b>
            <span>—Ä–µ–∞–∫—Ü–∏—è ‚Ä¢ –∫–æ–º–±–æ ‚Ä¢ –±–æ–Ω—É—Å—ã</span>
          </div>
        </div>

        <div class="pill">
          <div class="mini">
            <div class="k">–†–µ–∫–æ—Ä–¥</div>
            <div class="v" id="best">0</div>
          </div>
          <button class="btn" id="shareBtn" title="–û—Ç–ø—Ä–∞–≤–∏—Ç—å —Ä–µ–∑—É–ª—å—Ç–∞—Ç –±–æ—Ç—É">üì§</button>
        </div>
      </header>

      <div class="content">
        <div class="card">
          <div class="stats">
            <div class="stat">
              <div class="k">–°—á—ë—Ç</div>
              <div class="v" id="score">0</div>
              <div class="bar" title="—Å—É–ø–µ—Ä-—Ä–µ–∂–∏–º"><i id="meter"></i></div>
            </div>
            <div class="stat">
              <div class="k">–ö–æ–º–±–æ</div>
              <div class="v" id="combo">x1</div>
              <div class="k" id="comboHint" style="margin-top:6px">–Ω–µ –ø—Ä–æ–º–∞—Ö–Ω–∏—Å—å!</div>
            </div>
            <div class="stat">
              <div class="k">–í—Ä–µ–º—è</div>
              <div class="v"><span id="time">30.0</span>s</div>
              <div class="k" id="mode">–†–µ–∂–∏–º: Classic</div>
            </div>
          </div>
        </div>

        <div class="arenaWrap">
          <div class="arena card" id="arena">
            <div class="grid"></div>
            <div class="hint">
              <div>–¢–∞–ø–∞–π –ø–æ <b>–Ω–µ–æ–Ω—É</b>. üî• = –±–æ–ª—å—à–µ –æ—á–∫–æ–≤, üí• = –º–∏–Ω—É—Å.</div>
              <div><b>Space</b> —Å—Ç–∞—Ä—Ç/–ø–∞—É–∑–∞</div>
            </div>
          </div>

          <div class="card footer">
            <div class="left">
              <div class="toggle" id="soundToggle"><span class="dot"></span> –∑–≤—É–∫</div>
              <div class="toggle on" id="hardToggle"><span class="dot"></span> —Ö–∞—Ä–¥–∫–æ—Ä</div>
            </div>
            <button class="btn primary" id="startBtn">‚ñ∂ –ò–≥—Ä–∞—Ç—å</button>
          </div>
        </div>
      </div>
    </div>

    <div class="overlay" id="overlay">
      <div class="modal">
        <h1>Neon Tap</h1>
        <p>30 —Å–µ–∫—É–Ω–¥. –õ–æ–≤–∏ —Ü–µ–ª–∏: <b>üî•</b> –¥–∞—ë—Ç –±–æ–ª—å—à–µ –æ—á–∫–æ–≤, <b>‚≠ê</b> –∑–∞—Ä—è–∂–∞–µ—Ç —Å—É–ø–µ—Ä-—Ä–µ–∂–∏–º, <b>üí•</b> —Å–±–∏–≤–∞–µ—Ç –∫–æ–º–±–æ.</p>
        <div class="row">
          <button class="btn primary" id="playBtn">–ò–≥—Ä–∞—Ç—å</button>
          <button class="btn" id="howBtn">–ö–∞–∫ –∏–≥—Ä–∞—Ç—å</button>
        </div>
        <div class="tiny">–ü–æ–¥ Telegram WebApp: —Ä–µ–∑—É–ª—å—Ç–∞—Ç –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç—Å—è –∫–Ω–æ–ø–∫–æ–π üì§ –∏–ª–∏ –≤ –∫–æ–Ω—Ü–µ —Ä–∞—É–Ω–¥–∞.</div>
      </div>
    </div>
  </div>
</div>

<script>
(() => {
  // Telegram WebApp (–±–µ–∑ –æ—à–∏–±–æ–∫ –∏ –≤ –±—Ä–∞—É–∑–µ—Ä–µ)
  const TG = window.Telegram?.WebApp;
  try { TG?.ready(); TG?.expand(); } catch(e){}

  const els = {
    app: document.getElementById('app'),
    arena: document.getElementById('arena'),
    overlay: document.getElementById('overlay'),
    playBtn: document.getElementById('playBtn'),
    howBtn: document.getElementById('howBtn'),
    startBtn: document.getElementById('startBtn'),
    shareBtn: document.getElementById('shareBtn'),
    score: document.getElementById('score'),
    best: document.getElementById('best'),
    combo: document.getElementById('combo'),
    comboHint: document.getElementById('comboHint'),
    time: document.getElementById('time'),
    meter: document.getElementById('meter'),
    mode: document.getElementById('mode'),
    soundToggle: document.getElementById('soundToggle'),
    hardToggle: document.getElementById('hardToggle'),
    fx: document.getElementById('fx'),
  };

  // ---------- State ----------
  const LS_BEST = 'neon_tap_best_v1';
  let best = +localStorage.getItem(LS_BEST) || 0;

  let running = false;
  let paused = false;
  let tLeft = 30.0;

  let score = 0;
  let combo = 1;
  let streak = 0;

  let meter = 0;          // 0..100
  let superMode = false;  // when meter full
  let hard = true;
  let sound = false;

  let spawnTimer = 0;
  let targetCount = 0;

  // ---------- Audio (–±–µ–∑ —Ñ–∞–π–ª–æ–≤) ----------
  const AudioCtx = window.AudioContext || window.webkitAudioContext;
  let ctx = null;
  function beep(freq, dur=0.06, type='sine', gain=0.035){
    if(!sound) return;
    try{
      ctx ||= new AudioCtx();
      const o = ctx.createOscillator();
      const g = ctx.createGain();
      o.type = type; o.frequency.value = freq;
      g.gain.value = gain;
      o.connect(g); g.connect(ctx.destination);
      o.start();
      o.stop(ctx.currentTime + dur);
    }catch(e){}
  }

  // ---------- Particles FX ----------
  const c = els.fx;
  const g2 = c.getContext('2d');
  const P = [];
  let w=0,h=0,dpr=1;

  function resize(){
    const r = els.app.getBoundingClientRect();
    dpr = Math.min(2, window.devicePixelRatio || 1);
    w = Math.floor(r.width * dpr);
    h = Math.floor(r.height * dpr);
    c.width = w; c.height = h;
    c.style.width = r.width + 'px';
    c.style.height = r.height + 'px';
  }
  window.addEventListener('resize', resize, {passive:true});
  resize();

  function burst(x,y,n=18, power=1){
    for(let i=0;i<n;i++){
      const a = Math.random()*Math.PI*2;
      const sp = (Math.random()*2.6+1.1) * power;
      P.push({
        x,y,
        vx: Math.cos(a)*sp,
        vy: Math.sin(a)*sp,
        life: 1,
        r: Math.random()*3.2+1.2,
        hot: Math.random() > .55
      });
    }
  }

  let last = performance.now();
  function tick(now){
    const dt = Math.min(0.033, (now-last)/1000);
    last = now;

    // fade
    g2.clearRect(0,0,w,h);
    g2.globalAlpha = 1;

    // particles
    for(let i=P.length-1;i>=0;i--){
      const p = P[i];
      p.life -= dt*1.55;
      p.x += p.vx*60*dt;
      p.y += p.vy*60*dt;
      p.vx *= 0.985;
      p.vy *= 0.985;
      p.vy += 0.12;

      if(p.life<=0){ P.splice(i,1); continue; }

      const a = Math.max(0, p.life);
      g2.globalAlpha = a;
      g2.beginPath();
      g2.arc(p.x, p.y, p.r*dpr, 0, Math.PI*2);
      g2.fillStyle = p.hot ? 'rgba(255,79,216,.9)' : 'rgba(98,246,255,.9)';
      g2.shadowBlur = 16*dpr;
      g2.shadowColor = p.hot ? 'rgba(255,79,216,.7)' : 'rgba(98,246,255,.7)';
      g2.fill();
      g2.shadowBlur = 0;
    }

    // game clock
    if(running && !paused){
      tLeft -= dt;
      if(tLeft <= 0){
        tLeft = 0;
        endGame();
      }
      els.time.textContent = tLeft.toFixed(1);

      spawnTimer -= dt;
      if(spawnTimer <= 0){
        spawnTarget();
        const base = hard ? 0.62 : 0.78;
        spawnTimer = base * (superMode ? 0.75 : 1) * (0.92 + Math.random()*0.26);
      }
    }

    requestAnimationFrame(tick);
  }
  requestAnimationFrame(tick);

  // ---------- Targets ----------
  function rand(min,max){ return min + Math.random()*(max-min); }

  function spawnTarget(){
    // –æ–≥—Ä–∞–Ω–∏—á–∏–º –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –Ω–∞ –ø–æ–ª–µ
    const maxOnField = hard ? 4 : 5;
    const current = els.arena.querySelectorAll('.ring').length;
    if(current >= maxOnField) return;

    const rect = els.arena.getBoundingClientRect();
    const pad = 70;
    const x = rand(pad, rect.width - pad);
    const y = rand(90, rect.height - pad);

    // —Ç–∏–ø—ã —Ü–µ–ª–µ–π
    // good: +, hot: ++, warn: –∑–∞—Ä—è–¥, bad: —à—Ç—Ä–∞—Ñ
    const r = Math.random();
    let type = 'good', label = 'Ôºã', pts = 10, meterGain = 10;
    if(r > 0.86) { type='bad'; label='üí•'; pts = -18; meterGain = -22; }
    else if(r > 0.70){ type='hot'; label='üî•'; pts = 18; meterGain = 14; }
    else if(r > 0.56){ type='warn'; label='‚≠ê'; pts = 12; meterGain = 26; }

    // –≤ —Å—É–ø–µ—Ä-—Ä–µ–∂–∏–º–µ –±–æ–ª—å—à–µ "–≥–æ—Ä—è—á–∏—Ö"
    if(superMode && Math.random() > 0.62 && type !== 'bad'){
      type='hot'; label='üî•'; pts = 22; meterGain = 12;
    }

    const el = document.createElement('div');
    el.className = `ring ${type}`;
    el.style.left = x + 'px';
    el.style.top = y + 'px';
    el.style.opacity = '0';
    el.innerHTML = `<div class="core">${label}</div>`;
    els.arena.appendChild(el);

    // –∞–Ω–∏–º–∞—Ü–∏—è –ø–æ—è–≤–ª–µ–Ω–∏—è + —Ç–∞–π–º–µ—Ä –∏—Å—á–µ–∑–Ω–æ–≤–µ–Ω–∏—è
    const born = performance.now();
    const life = hard ? rand(0.78, 1.10) : rand(0.95, 1.25);
    const scale = rand(0.92, 1.12);

    function anim(){
      const t = (performance.now()-born)/1000;
      const p = Math.min(1, t/0.10);
      el.style.opacity = String(p);
      el.style.transform = `translate(-50%,-50%) scale(${(0.86 + p*0.14)*scale})`;

      if(!running || paused){ requestAnimationFrame(anim); return; }

      if(t > life){
        // –ø—Ä–æ–º–∞—Ö ‚Äî —Å–±—Ä–æ—Å –∫–æ–º–±–æ
        miss(el, x, y);
        return;
      }
      requestAnimationFrame(anim);
    }
    requestAnimationFrame(anim);

    el.addEventListener('pointerdown', (ev) => {
      ev.preventDefault();
      hit(type, pts, meterGain, el, x, y);
    }, {passive:false});
  }

  function miss(el, x, y){
    if(el?.isConnected) el.remove();
    combo = 1; streak = 0;
    els.combo.textContent = 'x' + combo;
    els.comboHint.textContent = '–º–∏–º–æ‚Ä¶ –∫–æ–º–±–æ —Å–±—Ä–æ—à–µ–Ω–æ';
    els.app.classList.add('shake');
    setTimeout(()=>els.app.classList.remove('shake'), 180);
    beep(120, 0.06, 'square', 0.03);
    burst(toAppX(x), toAppY(y), 14, 0.9);
  }

  function hit(type, pts, meterGain, el, x, y){
    if(!running || paused) return;
    if(el?.isConnected) el.remove();

    // –∫–æ–º–±–æ –ª–æ–≥–∏–∫–∞
    if(type === 'bad'){
      combo = 1; streak = 0;
      els.comboHint.textContent = 'üí• —à—Ç—Ä–∞—Ñ!';
      beep(150, 0.05, 'square', 0.04);
    } else {
      streak++;
      if(streak % 3 === 0) combo = Math.min(9, combo+1);
      els.comboHint.textContent = streak >= 6 ? 'üî• –æ—Ç–ª–∏—á–Ω–æ!' : '–¥–µ—Ä–∂–∏ —Ç–µ–º–ø';
      beep(520 + combo*30, 0.05, 'sine', 0.03);
    }

    // –æ—á–∫–∏
    const mult = superMode ? 2 : 1;
    const add = Math.round(pts * combo * mult);
    score += add;
    score = Math.max(0, score);
    els.score.textContent = score;

    // —Å—É–ø–µ—Ä-–º–µ—Ç—Ä
    meter = Math.max(0, Math.min(100, meter + meterGain));
    els.meter.style.width = meter + '%';

    if(meter >= 100 && !superMode){
      superMode = true;
      els.mode.textContent = '–†–µ–∂–∏–º: SUPER ‚ú®';
      burst(toAppX(x), toAppY(y), 30, 1.4);
      beep(880, 0.10, 'triangle', 0.05);
      setTimeout(() => {
        // —Å—É–ø–µ—Ä —Ä–µ–∂–∏–º –¥–ª–∏—Ç—Å—è –Ω–µ–º–Ω–æ–≥–æ –∏ –ø–ª–∞–≤–Ω–æ —É—Ö–æ–¥–∏—Ç
        superMode = false;
        meter = 0;
        els.meter.style.width = '0%';
        els.mode.textContent = hard ? '–†–µ–∂–∏–º: Hardcore' : '–†–µ–∂–∏–º: Classic';
      }, 5200);
    }

    els.combo.textContent = 'x' + combo;

    // fx
    const bx = toAppX(x), by = toAppY(y);
    burst(bx, by, type==='bad' ? 10 : 22, type==='hot' ? 1.25 : 1);
    floatText(bx, by, (add>=0?'+':'')+add, type);
  }

  // –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã –∞—Ä–µ–Ω—ã -> canvas app
  function toAppX(arenaX){
    const a = els.arena.getBoundingClientRect();
    const app = els.app.getBoundingClientRect();
    return (a.left - app.left + arenaX) * dpr;
  }
  function toAppY(arenaY){
    const a = els.arena.getBoundingClientRect();
    const app = els.app.getBoundingClientRect();
    return (a.top - app.top + arenaY) * dpr;
  }

  function floatText(x,y,txt,type){
    const div = document.createElement('div');
    div.textContent = txt;
    div.style.position='absolute';
    div.style.left = (x/dpr)+'px';
    div.style.top  = (y/dpr - 10)+'px';
    div.style.transform='translate(-50%,-50%)';
    div.style.fontWeight='900';
    div.style.letterSpacing='.2px';
    div.style.pointerEvents='none';
    div.style.zIndex='4';
    div.style.textShadow='0 10px 30px rgba(0,0,0,.55)';
    div.style.opacity='0';
    div.style.transition='transform .55s ease, opacity .55s ease';
    div.style.fontSize='16px';
    const col = (type==='hot') ? 'rgba(255,79,216,.95)'
              : (type==='warn')? 'rgba(255,209,102,.95)'
              : (type==='bad') ? 'rgba(255,59,92,.95)'
              : 'rgba(98,246,255,.95)';
    div.style.color = col;
    els.app.appendChild(div);

    requestAnimationFrame(()=> {
      div.style.opacity='1';
      div.style.transform='translate(-50%,-80%)';
    });
    setTimeout(()=> {
      div.style.opacity='0';
      div.style.transform='translate(-50%,-110%)';
    }, 320);
    setTimeout(()=> div.remove(), 900);
  }

  // ---------- Game flow ----------
  function reset(){
    score = 0; combo = 1; streak = 0; meter = 0; superMode = false;
    tLeft = 30.0;
    els.score.textContent = '0';
    els.combo.textContent = 'x1';
    els.comboHint.textContent = '–Ω–µ –ø—Ä–æ–º–∞—Ö–Ω–∏—Å—å!';
    els.time.textContent = tLeft.toFixed(1);
    els.meter.style.width = '0%';
    els.mode.textContent = hard ? '–†–µ–∂–∏–º: Hardcore' : '–†–µ–∂–∏–º: Classic';
    clearTargets();
  }

  function clearTargets(){
    els.arena.querySelectorAll('.ring').forEach(n=>n.remove());
  }

  function startGame(){
    reset();
    running = true;
    paused = false;
    spawnTimer = 0.15;
    els.overlay.style.display = 'none';
    els.startBtn.textContent = '‚è∏ –ü–∞—É–∑–∞';
    beep(660, 0.06, 'triangle', 0.04);
  }

  function togglePause(){
    if(!running) return;
    paused = !paused;
    els.startBtn.textContent = paused ? '‚ñ∂ –ü—Ä–æ–¥–æ–ª–∂–∏—Ç—å' : '‚è∏ –ü–∞—É–∑–∞';
    els.comboHint.textContent = paused ? '–ø–∞—É–∑–∞' : '–≤–ø–µ—Ä—ë–¥!';
    beep(paused ? 260 : 520, 0.06, 'sine', 0.03);
  }

  function endGame(){
    running = false; paused = false;
    clearTargets();
    if(score > best){
      best = score;
      localStorage.setItem(LS_BEST, best);
    }
    els.best.textContent = best;

    // –∞–≤—Ç–æ—Å–µ–Ω–¥ –≤ Telegram
    sendResult({ score, best, hard });

    els.overlay.style.display = 'grid';
    els.overlay.querySelector('h1').textContent = '–†–∞—É–Ω–¥ –æ–∫–æ–Ω—á–µ–Ω';
    els.overlay.querySelector('p').innerHTML =
      `–¢–≤–æ–π —Å—á—ë—Ç: <b>${score}</b> ‚Ä¢ —Ä–µ–∫–æ—Ä–¥: <b>${best}</b><br><span style="color:rgba(255,255,255,.6)">–ù–∞–∂–º–∏ ‚Äú–ò–≥—Ä–∞—Ç—å‚Äù, —á—Ç–æ–±—ã –ø–æ–ø—Ä–æ–±–æ–≤–∞—Ç—å –µ—â—ë —Ä–∞–∑.</span>`;
    els.startBtn.textContent = '‚ñ∂ –ò–≥—Ä–∞—Ç—å';
    beep(220, 0.12, 'triangle', 0.04);
  }

  function sendResult(payload){
    // payload –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å —Å—Ç—Ä–æ–∫–æ–π
    const data = JSON.stringify({
      game: 'neon_tap',
      ts: Date.now(),
      ...payload
    });
    try{
      if(TG?.sendData){
        TG.sendData(data);
        TG.HapticFeedback?.notificationOccurred?.('success');
      }
    }catch(e){}
  }

  // ---------- UI events ----------
  els.best.textContent = best;

  els.playBtn.addEventListener('click', () => startGame());
  els.startBtn.addEventListener('click', () => {
    if(!running) startGame();
    else togglePause();
  });

  els.howBtn.addEventListener('click', () => {
    els.overlay.querySelector('h1').textContent = '–ö–∞–∫ –∏–≥—Ä–∞—Ç—å';
    els.overlay.querySelector('p').innerHTML =
      `–¢–∞–ø–∞–π –ø–æ —Ü–µ–ª—è–º –¥–æ —Ç–æ–≥–æ, –∫–∞–∫ –æ–Ω–∏ –∏—Å—á–µ–∑–Ω—É—Ç.<br>
       <b>üî•</b> = –º–Ω–æ–≥–æ –æ—á–∫–æ–≤ ‚Ä¢ <b>‚≠ê</b> = –∑–∞—Ä—è–¥ —Å—É–ø–µ—Ä-—Ä–µ–∂–∏–º–∞ ‚Ä¢ <b>üí•</b> = —Å–±—Ä–æ—Å –∫–æ–º–±–æ.<br>
       –ö–∞–∂–¥—ã–µ 3 –ø–æ–ø–∞–¥–∞–Ω–∏—è —É–≤–µ–ª–∏—á–∏–≤–∞—é—Ç –∫–æ–º–±–æ. –ü—Ä–æ–º–∞—Ö ‚Äî –∫–æ–º–±–æ –≤ –Ω–æ–ª—å.`;
  });

  els.shareBtn.addEventListener('click', () => {
    sendResult({ score, best, hard, manual:true });
    beep(740, 0.06, 'triangle', 0.04);
  });

  els.soundToggle.addEventListener('click', () => {
    sound = !sound;
    els.soundToggle.classList.toggle('on', sound);
    if(sound) beep(520,0.06,'sine',0.03);
  });

  els.hardToggle.addEventListener('click', () => {
    hard = !hard;
    els.hardToggle.classList.toggle('on', hard);
    els.mode.textContent = hard ? '–†–µ–∂–∏–º: Hardcore' : '–†–µ–∂–∏–º: Classic';
    beep(hard ? 420 : 320, 0.06, 'sine', 0.03);
  });

  // Space ‚Äî —Å—Ç–∞—Ä—Ç/–ø–∞—É–∑–∞
  window.addEventListener('keydown', (e) => {
    if(e.code === 'Space'){
      e.preventDefault();
      if(!running) startGame();
      else togglePause();
    }
  });

  // –¢–µ–ª–µ–≥—Ä–∞–º-—Ü–≤–µ—Ç–∞/—Ç–µ–º–∞
  try{
    const th = TG?.themeParams;
    if(th?.text_color){
      document.documentElement.style.setProperty('--txt', th.text_color);
    }
  }catch(e){}

})();
</script>
</body>
</html>
