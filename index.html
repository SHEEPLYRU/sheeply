<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no"/>
  <title>NOIR iPuzzle ‚Äî —Å–æ–±–µ—Ä–∏ iPhone</title>
  <style>
    :root{
      --bg:#0a0a0a;
      --panel: rgba(255,255,255,.06);
      --panel2: rgba(255,255,255,.09);
      --border: rgba(255,255,255,.14);
      --text: rgba(255,255,255,.92);
      --muted: rgba(255,255,255,.62);
      --shadow: 0 18px 60px rgba(0,0,0,.55);
      --r: 22px;
      --good: rgba(255,255,255,.90);
      --dim: rgba(255,255,255,.35);
    }
    *{box-sizing:border-box}
    html,body{height:100%;margin:0;overflow:hidden;background:var(--bg);color:var(--text);
      font-family: system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif}
    .wrap{height:100%;display:grid;place-items:center;padding:14px}
    .app{
      width:min(560px,100%); height:min(940px,100%);
      border-radius: clamp(18px, 3vw, 30px);
      background:
        radial-gradient(900px 520px at 20% 0%, rgba(255,255,255,.08), transparent 60%),
        radial-gradient(900px 520px at 90% 20%, rgba(255,255,255,.06), transparent 60%),
        linear-gradient(180deg, rgba(255,255,255,.04), rgba(255,255,255,.02));
      border:1px solid var(--border);
      box-shadow: var(--shadow);
      backdrop-filter: blur(12px);
      overflow:hidden;
      position:relative;
    }
    canvas#fx{position:absolute;inset:0;z-index:1}
    .ui{position:relative;z-index:2;height:100%;display:flex;flex-direction:column}
    header{
      padding:14px 16px 10px;
      display:flex;align-items:center;justify-content:space-between;gap:10px;
    }
    .brand{display:flex;gap:10px;align-items:center}
    .logo{
      width:40px;height:40px;border-radius:14px;
      background: linear-gradient(180deg, rgba(255,255,255,.18), rgba(255,255,255,.06));
      border:1px solid rgba(255,255,255,.18);
      box-shadow: 0 14px 40px rgba(0,0,0,.35), inset 0 0 22px rgba(255,255,255,.06);
      position:relative; overflow:hidden;
    }
    .logo:after{
      content:""; position:absolute; inset:-40%;
      background: conic-gradient(from 180deg, transparent, rgba(255,255,255,.22), transparent);
      animation: spin 3.4s linear infinite;
      filter: blur(.3px);
    }
    @keyframes spin{to{transform:rotate(360deg)}}
    .title b{display:block;font-size:14px;letter-spacing:.6px}
    .title span{display:block;font-size:12px;color:var(--muted)}
    .pill{
      display:flex;gap:10px;align-items:center;
      padding:8px 10px;border-radius:999px;
      background: rgba(255,255,255,.05);
      border:1px solid rgba(255,255,255,.12);
    }
    .mini{display:flex;flex-direction:column;gap:2px;min-width:92px;text-align:right}
    .mini .k{font-size:11px;color:var(--muted)}
    .mini .v{font-size:14px;font-weight:900}
    .btn{
      border:none;cursor:pointer;color:var(--text);
      padding:10px 12px;border-radius:14px;
      background: linear-gradient(180deg, rgba(255,255,255,.10), rgba(255,255,255,.05));
      border:1px solid rgba(255,255,255,.14);
      box-shadow: 0 12px 30px rgba(0,0,0,.25);
      transition: transform .08s ease, filter .15s ease;
      user-select:none;
    }
    .btn:active{transform: translateY(1px) scale(.99); filter:brightness(1.05);}
    .btn.primary{
      background: linear-gradient(180deg, rgba(255,255,255,.16), rgba(255,255,255,.06));
      border-color: rgba(255,255,255,.22);
    }

    .content{flex:1;display:flex;flex-direction:column;gap:12px;padding:0 16px 16px}
    .card{
      background: rgba(255,255,255,.06);
      border:1px solid rgba(255,255,255,.10);
      border-radius: var(--r);
      box-shadow: 0 14px 40px rgba(0,0,0,.28);
      overflow:hidden;
    }

    .topbar{
      display:flex;gap:10px;align-items:center;justify-content:space-between;
      padding:12px;
    }
    .chips{display:flex;gap:8px;flex-wrap:wrap}
    .chip{
      font-size:12px;color:var(--muted);
      padding:8px 10px;border-radius:999px;
      background: rgba(255,255,255,.05);
      border:1px solid rgba(255,255,255,.12);
      user-select:none;
    }
    .chip b{color:var(--text)}
    .arena{
      height: clamp(460px, 62vh, 650px);
      position:relative;
      border-radius: var(--r);
      background:
        radial-gradient(700px 380px at 50% 10%, rgba(255,255,255,.10), transparent 65%),
        linear-gradient(180deg, rgba(0,0,0,.34), rgba(0,0,0,.16));
      border:1px solid rgba(255,255,255,.12);
      overflow:hidden;
      touch-action: none;
    }
    .grid{
      position:absolute; inset:-20%;
      background:
        radial-gradient(circle at 50% 50%, rgba(255,255,255,.05) 0 1px, transparent 2px),
        linear-gradient(90deg, rgba(255,255,255,.035) 1px, transparent 1px),
        linear-gradient(0deg, rgba(255,255,255,.035) 1px, transparent 1px);
      background-size: 28px 28px, 96px 96px, 96px 96px;
      transform: rotate(10deg);
      opacity:.35;
      pointer-events:none;
    }
    .grain{
      position:absolute;inset:0;pointer-events:none;opacity:.16;mix-blend-mode:overlay;
      background-image:url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='120' height='120'%3E%3Cfilter id='n'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='.9' numOctaves='2' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='120' height='120' filter='url(%23n)' opacity='.5'/%3E%3C/svg%3E");
    }

    /* ‚Äú–∫–æ–Ω—Ç—É—Ä iPhone‚Äù ‚Äî –∫—É–¥–∞ —Å–æ–±–∏—Ä–∞—Ç—å */
    .board{
      position:absolute;
      left:50%; top:50%;
      width:min(280px, 60vw);
      aspect-ratio: 9/19.5;
      transform: translate(-50%,-50%);
      border-radius: 40px;
      border:1px solid rgba(255,255,255,.20);
      background: rgba(255,255,255,.03);
      box-shadow: inset 0 0 0 1px rgba(0,0,0,.35), 0 30px 80px rgba(0,0,0,.50);
    }
    .board:before{
      content:""; position:absolute; left:50%; top:10px; transform:translateX(-50%);
      width:36%; height:20px; border-radius:999px;
      background: rgba(255,255,255,.06);
      border:1px solid rgba(255,255,255,.12);
    }
    .board:after{
      content:""; position:absolute; inset:10px;
      border-radius: 34px;
      border:1px dashed rgba(255,255,255,.14);
      opacity:.8;
    }

    /* ‚Äú—Å–ª–æ—Ç—ã‚Äù –≤–Ω—É—Ç—Ä–∏ iPhone */
    .slot{
      position:absolute;
      border-radius: 18px;
      background: rgba(255,255,255,.04);
      border:1px dashed rgba(255,255,255,.18);
      box-shadow: inset 0 0 18px rgba(255,255,255,.04);
    }
    .slot.ok{
      border-style: solid;
      background: rgba(255,255,255,.07);
      border-color: rgba(255,255,255,.28);
      box-shadow: inset 0 0 22px rgba(255,255,255,.06), 0 0 30px rgba(255,255,255,.08);
    }

    /* –ü–∞–∑–ª—ã */
    .piece{
      position:absolute;
      border-radius: 18px;
      background: radial-gradient(circle at 30% 30%, rgba(255,255,255,.18), rgba(255,255,255,.06));
      border:1px solid rgba(255,255,255,.18);
      box-shadow: 0 18px 60px rgba(0,0,0,.35), inset 0 0 18px rgba(255,255,255,.05);
      display:flex; align-items:center; justify-content:center;
      font-weight:950; letter-spacing:.6px;
      user-select:none;
      cursor:grab;
      touch-action:none;
      transition: filter .12s ease;
    }
    .piece:active{cursor:grabbing; filter:brightness(1.08)}
    .piece.placed{
      cursor:default;
      border-color: rgba(255,255,255,.28);
      box-shadow: 0 22px 70px rgba(0,0,0,.28), inset 0 0 18px rgba(255,255,255,.06);
    }

    .footer{
      padding:12px;
      display:flex;justify-content:space-between;align-items:center;gap:10px;
    }

    .overlay{
      position:absolute; inset:0; z-index:3;
      display:grid; place-items:center; padding:18px;
      background: radial-gradient(800px 520px at 50% 25%, rgba(255,255,255,.10), rgba(0,0,0,.45) 70%),
                  rgba(0,0,0,.30);
      backdrop-filter: blur(12px);
    }
    .modal{
      width:min(440px,100%);
      border-radius: 26px;
      background: rgba(255,255,255,.08);
      border:1px solid rgba(255,255,255,.14);
      box-shadow: var(--shadow);
      padding:16px;
    }
    .modal h1{margin:0 0 6px;font-size:18px;letter-spacing:.6px}
    .modal p{margin:0 0 12px;color:var(--muted);font-size:13px;line-height:1.35}
    .row{display:flex;gap:10px;flex-wrap:wrap}
    .row .btn{flex:1}
    .promo{
      margin:12px 0;
      padding:12px 12px;border-radius:18px;
      background: rgba(0,0,0,.22);
      border:1px dashed rgba(255,255,255,.22);
      display:flex;align-items:center;justify-content:space-between;gap:10px;
      font-weight:950; letter-spacing:.8px;
    }
    .tiny{font-size:11px;color:rgba(255,255,255,.55);margin-top:10px}
    .shake{animation: shake .18s linear 1}
    @keyframes shake{
      0%{transform:translateX(0)}25%{transform:translateX(-3px)}
      50%{transform:translateX(3px)}75%{transform:translateX(-2px)}
      100%{transform:translateX(0)}
    }
  </style>
</head>
<body>
<div class="wrap">
  <div class="app" id="app">
    <canvas id="fx"></canvas>

    <div class="ui">
      <header>
        <div class="brand">
          <div class="logo" aria-hidden="true"></div>
          <div class="title">
            <b>NOIR iPUZZLE</b>
            <span>—Å–æ–±–µ—Ä–∏ iPhone –∏–∑ –¥–µ—Ç–∞–ª–µ–π (–ø–∞–∑–ª)</span>
          </div>
        </div>
        <div class="pill">
          <div class="mini">
            <div class="k">–í—Ä–µ–º—è</div>
            <div class="v"><span id="time">0.0</span>s</div>
          </div>
          <button class="btn" id="sendBtn" title="–û—Ç–ø—Ä–∞–≤–∏—Ç—å —Ä–µ–∑—É–ª—å—Ç–∞—Ç –±–æ—Ç—É">‚§¥</button>
        </div>
      </header>

      <div class="content">
        <div class="card">
          <div class="topbar">
            <div class="chips">
              <div class="chip">–ü–µ—Ä–µ—Ç–∞—â–∏ –¥–µ—Ç–∞–ª–∏ –≤ <b>–∫–æ–Ω—Ç—É—Ä</b></div>
              <div class="chip">–ï—Å–ª–∏ –±–ª–∏–∑–∫–æ ‚Äî <b>–ø—Ä–∏–ª–∏–ø–Ω–µ—Ç</b></div>
            </div>
            <div class="chips">
              <div class="chip">–°–æ–±—Ä–∞–Ω–æ: <b id="done">0</b>/6</div>
              <button class="btn" id="resetBtn">‚Üª –∑–∞–Ω–æ–≤–æ</button>
            </div>
          </div>
        </div>

        <div class="arena card" id="arena">
          <div class="grid"></div>
          <div class="grain"></div>

          <div class="board" id="board">
            <!-- slots injected by JS -->
          </div>

          <div id="pieces"></div>
        </div>

        <div class="card footer">
          <div class="chip" id="status">–°–æ–±–µ—Ä–∏ –≤—Å–µ 6 –¥–µ—Ç–∞–ª–µ–π ‚Äî iPhone –≥–æ—Ç–æ–≤.</div>
          <button class="btn primary" id="startBtn">‚ñ∂ –°—Ç–∞—Ä—Ç</button>
        </div>
      </div>
    </div>

    <div class="overlay" id="overlay">
      <div class="modal">
        <h1 id="ovTitle">NOIR iPUZZLE</h1>
        <p id="ovText">
          –ë—ã—Å—Ç—Ä–∞—è —á/–± –∏–≥—Ä–∞-–ø–∞–∑–ª –¥–ª—è Telegram WebApp.<br>
          –ù–∞–∂–º–∏ ¬´–°—Ç–∞—Ä—Ç¬ª –∏ —Å–æ–±–µ—Ä–∏ iPhone –∫–∞–∫ –º–æ–∂–Ω–æ –±—ã—Å—Ç—Ä–µ–µ.
        </p>
        <div class="row">
          <button class="btn primary" id="playBtn">–°—Ç–∞—Ä—Ç</button>
          <button class="btn" id="howBtn">–ö–∞–∫ –∏–≥—Ä–∞—Ç—å</button>
        </div>
        <div class="tiny">
          –î–ª—è –Ω–∞—Å—Ç–æ—è—â–∏—Ö –ø—Ä–æ–º–æ/–ø—Ä–∏–∑–æ–≤ –Ω–µ —Ö—Ä–∞–Ω–∏ –≤—ã–¥–∞—á—É –≤ HTML ‚Äî –¥–µ–ª–∞–π —á–µ—Ä–µ–∑ –±–æ—Ç–∞/—Å–µ—Ä–≤–µ—Ä.
        </div>
      </div>
    </div>
  </div>
</div>

<script>
(() => {
  const TG = window.Telegram?.WebApp;
  try{ TG?.ready(); TG?.expand(); }catch(e){}

  const els = {
    app: document.getElementById('app'),
    fx: document.getElementById('fx'),
    arena: document.getElementById('arena'),
    board: document.getElementById('board'),
    piecesWrap: document.getElementById('pieces'),
    overlay: document.getElementById('overlay'),

    playBtn: document.getElementById('playBtn'),
    howBtn: document.getElementById('howBtn'),
    startBtn: document.getElementById('startBtn'),
    resetBtn: document.getElementById('resetBtn'),
    sendBtn: document.getElementById('sendBtn'),

    time: document.getElementById('time'),
    done: document.getElementById('done'),
    status: document.getElementById('status'),
    ovTitle: document.getElementById('ovTitle'),
    ovText: document.getElementById('ovText'),
  };

  // --- Simple particles (black/white) ---
  const c = els.fx, ctx = c.getContext('2d');
  let w=0,h=0,dpr=1;
  const P=[];
  function resize(){
    const r = els.app.getBoundingClientRect();
    dpr = Math.min(2, window.devicePixelRatio||1);
    w = Math.floor(r.width*dpr);
    h = Math.floor(r.height*dpr);
    c.width=w; c.height=h;
    c.style.width=r.width+'px';
    c.style.height=r.height+'px';
  }
  window.addEventListener('resize', resize, {passive:true}); resize();
  function burst(x,y,n=18,bright=true){
    for(let i=0;i<n;i++){
      const a=Math.random()*Math.PI*2;
      const sp=(Math.random()*2.2+1.0)*(bright?1.05:.95);
      P.push({x,y,vx:Math.cos(a)*sp,vy:Math.sin(a)*sp,life:1,r:Math.random()*3+1,bright});
    }
  }
  let last=performance.now();
  function tick(now){
    const dt=Math.min(0.033,(now-last)/1000); last=now;
    ctx.clearRect(0,0,w,h);
    for(let i=P.length-1;i>=0;i--){
      const p=P[i];
      p.life-=dt*1.55;
      p.x+=p.vx*60*dt; p.y+=p.vy*60*dt;
      p.vx*=0.985; p.vy*=0.985; p.vy+=0.12;
      if(p.life<=0){P.splice(i,1); continue;}
      ctx.globalAlpha=Math.max(0,p.life);
      ctx.beginPath();
      ctx.arc(p.x,p.y,p.r*dpr,0,Math.PI*2);
      ctx.fillStyle = p.bright ? 'rgba(255,255,255,.95)' : 'rgba(255,255,255,.35)';
      ctx.shadowBlur = 16*dpr;
      ctx.shadowColor = p.bright ? 'rgba(255,255,255,.25)' : 'rgba(255,255,255,.14)';
      ctx.fill();
      ctx.shadowBlur=0;
    }

    if(running){
      const t = (performance.now() - t0) / 1000;
      els.time.textContent = t.toFixed(1);
    }

    requestAnimationFrame(tick);
  }
  requestAnimationFrame(tick);

  function appXYFromClient(clientX, clientY){
    const ra = els.app.getBoundingClientRect();
    return { x:(clientX-ra.left)*dpr, y:(clientY-ra.top)*dpr };
  }
  function appXYFromElCenter(el){
    const r = el.getBoundingClientRect();
    const a = els.app.getBoundingClientRect();
    return { x:(r.left-a.left+r.width/2)*dpr, y:(r.top-a.top+r.height/2)*dpr };
  }

  // --- Game state ---
  let running = false;
  let t0 = 0;
  let placed = 0;

  // 6 –¥–µ—Ç–∞–ª–µ–π –≤ —Å—Ç–∏–ª–µ ‚Äú–∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ã iPhone‚Äù (–±–µ–∑ –ª–æ–≥–æ—Ç–∏–ø–æ–≤/–∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π):
  // –í–∏–∑—É–∞–ª—å–Ω–æ —ç—Ç–æ –∞–±—Å—Ç—Ä–∞–∫—Ç–Ω—ã–µ –±–ª–æ–∫–∏: —ç–∫—Ä–∞–Ω, –∫–∞–º–µ—Ä–∞, –ø–ª–∞—Ç–∞, –±–∞—Ç–∞—Ä–µ—è, –¥–∏–Ω–∞–º–∏–∫, Taptic.
  const slots = [
    { id:'screen',  label:'SCREEN',  x: 14, y: 10, w: 72, h: 46, r: 26 },
    { id:'camera',  label:'CAM',     x: 12, y: 60, w: 28, h: 20, r: 18 },
    { id:'board',   label:'BOARD',   x: 46, y: 60, w: 42, h: 24, r: 18 },
    { id:'battery', label:'BAT',     x: 12, y: 84, w: 50, h: 26, r: 18 },
    { id:'speaker', label:'SPK',     x: 66, y: 84, w: 22, h: 12, r: 14 },
    { id:'taptic',  label:'TAPTIC',  x: 66, y: 97, w: 22, h: 13, r: 14 },
  ];

  // --- Build slots (inside board) ---
  function buildSlots(){
    els.board.querySelectorAll('.slot').forEach(s=>s.remove());
    for(const s of slots){
      const el = document.createElement('div');
      el.className = 'slot';
      el.dataset.id = s.id;
      el.style.left = s.x + '%';
      el.style.top  = s.y + '%';
      el.style.width  = s.w + '%';
      el.style.height = s.h + '%';
      el.style.borderRadius = (s.r) + 'px';
      els.board.appendChild(el);
    }
  }

  // --- Build pieces, scatter around board ---
  function buildPieces(){
    els.piecesWrap.innerHTML = '';
    placed = 0;
    els.done.textContent = '0';

    const arenaR = els.arena.getBoundingClientRect();
    const boardR = els.board.getBoundingClientRect();

    // –∑–æ–Ω—ã —Ä–∞–∑–±—Ä–æ—Å–∞: –ª–µ–≤—ã–π/–ø—Ä–∞–≤—ã–π —Å—Ç–æ–ª
    const leftZone = { x: 18, y: 130, w: Math.max(80, boardR.left - arenaR.left - 24), h: arenaR.height - 180 };
    const rightZone= { x: (boardR.right - arenaR.left) + 24, y: 130, w: Math.max(80, arenaR.right - boardR.right - 40), h: arenaR.height - 180 };

    // –µ—Å–ª–∏ —ç–∫—Ä–∞–Ω –º–∞–ª–µ–Ω—å–∫–∏–π ‚Äî —Ä–∞–∑–±—Ä–æ—Å –ø–æ–¥ –¥–æ—Å–∫–æ–π
    const fallbackZone = { x: 24, y: (boardR.bottom - arenaR.top) + 24, w: arenaR.width - 48, h: Math.max(120, arenaR.height - (boardR.bottom - arenaR.top) - 48) };

    const zones = (leftZone.w > 90 && rightZone.w > 90) ? [leftZone, rightZone] : [fallbackZone];

    // —Å–æ–∑–¥–∞—Ç—å ‚Äú–∫—É—Å–æ—á–∫–∏‚Äù —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—â–∏–µ —Å–ª–æ—Ç–∞–º
    for(const s of slots){
      const p = document.createElement('div');
      p.className = 'piece';
      p.dataset.id = s.id;
      p.textContent = s.label;

      // —Ä–∞–∑–º–µ—Ä —Å–æ–≤–ø–∞–¥–∞–µ—Ç —Å–æ —Å–ª–æ—Ç–æ–º (–≤ px –æ—Ç–Ω–æ—Å–∏—Ç–µ–ª—å–Ω–æ board)
      const bw = boardR.width, bh = boardR.height;
      const pw = (s.w/100)*bw;
      const ph = (s.h/100)*bh;

      p.style.width = pw + 'px';
      p.style.height = ph + 'px';
      p.style.borderRadius = (s.r) + 'px';

      // –ø–æ–∑–∏—Ü–∏—è —Å–ª—É—á–∞–π–Ω–æ –≤ –∑–æ–Ω–µ
      const z = zones[Math.floor(Math.random()*zones.length)];
      const px = z.x + Math.random()*(Math.max(10, z.w - pw));
      const py = z.y + Math.random()*(Math.max(10, z.h - ph));
      p.style.left = px + 'px';
      p.style.top  = py + 'px';

      enableDrag(p);
      els.piecesWrap.appendChild(p);
    }
  }

  // --- Drag & snap ---
  function enableDrag(el){
    let pointerId = null;
    let startX=0, startY=0, baseX=0, baseY=0;
    let dragging=false;

    el.addEventListener('pointerdown', (e)=>{
      if(!running) return;
      if(el.classList.contains('placed')) return;
      pointerId = e.pointerId;
      el.setPointerCapture(pointerId);
      dragging=true;

      const r = el.getBoundingClientRect();
      startX = e.clientX;
      startY = e.clientY;
      baseX = parseFloat(el.style.left);
      baseY = parseFloat(el.style.top);

      el.style.zIndex = '10';
    });

    el.addEventListener('pointermove', (e)=>{
      if(!dragging || e.pointerId !== pointerId) return;
      const dx = e.clientX - startX;
      const dy = e.clientY - startY;
      el.style.left = (baseX + dx) + 'px';
      el.style.top  = (baseY + dy) + 'px';
    });

    el.addEventListener('pointerup', (e)=>{
      if(!dragging || e.pointerId !== pointerId) return;
      dragging=false;
      el.releasePointerCapture(pointerId);
      el.style.zIndex = '';

      // –ø—Ä–æ–≤–µ—Ä–∏—Ç—å "–ø—Ä–∏–ª–∏–ø–∞–Ω–∏–µ" –∫ —Å–≤–æ–µ–º—É —Å–ª–æ—Ç—É
      const id = el.dataset.id;
      const slotEl = els.board.querySelector(`.slot[data-id="${id}"]`);
      if(!slotEl) return;

      const pr = el.getBoundingClientRect();
      const sr = slotEl.getBoundingClientRect();

      const pcx = pr.left + pr.width/2;
      const pcy = pr.top + pr.height/2;
      const scx = sr.left + sr.width/2;
      const scy = sr.top + sr.height/2;

      const dist = Math.hypot(pcx-scx, pcy-scy);
      const snapDist = Math.min(52, Math.max(34, sr.width*0.18)); // –∞–¥–∞–ø—Ç–∏–≤–Ω–æ

      if(dist <= snapDist){
        // —Å–Ω–∞–ø: –ø–æ—Å—Ç–∞–≤–∏—Ç—å —Ç–æ—á–Ω–æ –Ω–∞ —Å–ª–æ—Ç (–≤ –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç–∞—Ö –∞—Ä–µ–Ω—ã)
        const arenaR = els.arena.getBoundingClientRect();
        const left = (sr.left - arenaR.left);
        const top  = (sr.top  - arenaR.top);
        el.style.left = left + 'px';
        el.style.top  = top  + 'px';
        el.classList.add('placed');
        slotEl.classList.add('ok');
        placed++;
        els.done.textContent = String(placed);

        // fx
        const xy = appXYFromElCenter(slotEl);
        burst(xy.x, xy.y, 26, true);

        try{ TG?.HapticFeedback?.impactOccurred?.('light'); }catch(e){}
        els.status.textContent = placed === slots.length
          ? '–ì–æ—Ç–æ–≤–æ! iPhone —Å–æ–±—Ä–∞–Ω.'
          : '–û—Ç–ª–∏—á–Ω–æ! –ü—Ä–æ–¥–æ–ª–∂–∞–π.';

        if(placed === slots.length){
          win();
        }
      } else {
        // –º–∞–ª–µ–Ω—å–∫–∞—è ‚Äú–æ—à–∏–±–∫–∞‚Äù
        els.app.classList.add('shake');
        setTimeout(()=>els.app.classList.remove('shake'),180);
        try{ TG?.HapticFeedback?.impactOccurred?.('medium'); }catch(e){}
      }
    });
  }

  function resetBoardVisual(){
    els.board.querySelectorAll('.slot').forEach(s=>s.classList.remove('ok'));
  }

  // --- Win / overlay ---
  function sendResult(manual){
    const time = parseFloat(els.time.textContent);
    const data = JSON.stringify({
      game:'noir_ipuzzle',
      placed, total: slots.length,
      time,
      win: placed===slots.length,
      manual: !!manual,
      ts: Date.now()
    });
    try{
      if(TG?.sendData){
        TG.sendData(data);
        TG?.HapticFeedback?.notificationOccurred?.('success');
      }
    }catch(e){}
  }

  function win(){
    running=false;
    sendResult(false);

    els.overlay.style.display='grid';
    els.ovTitle.textContent = '–°–æ–±—Ä–∞–Ω–æ üéâ';
    els.ovText.innerHTML = `–¢—ã —Å–æ–±—Ä–∞–ª iPhone –∑–∞ <b>${els.time.textContent}s</b>.<br><span style="color:rgba(255,255,255,.62)">–ú–æ–∂–µ—à—å –æ—Ç–ø—Ä–∞–≤–∏—Ç—å —Ä–µ–∑—É–ª—å—Ç–∞—Ç –±–æ—Ç—É –∏–ª–∏ —Å—ã–≥—Ä–∞—Ç—å —Å–Ω–æ–≤–∞.</span>`;
    // –∫–Ω–æ–ø–∫–∏ –≤ –æ–≤–µ—Ä–ª–µ–µ —É–∂–µ –µ—Å—Ç—å ‚Äî –æ—Å—Ç–∞–≤–ª—è–µ–º
    const xy = appXYFromElCenter(els.board);
    burst(xy.x, xy.y, 60, true);
  }

  // --- Flow ---
  function start(){
    reset();
    running=true;
    t0 = performance.now();
    els.overlay.style.display='none';
    els.startBtn.textContent = '‚è∏ –ü–∞—É–∑–∞';
    els.status.textContent = '–°–æ–±–∏—Ä–∞–π: –ø–µ—Ä–µ—Ç–∞—Å–∫–∏–≤–∞–π –¥–µ—Ç–∞–ª–∏ –≤ –∫–æ–Ω—Ç—É—Ä.';
  }
  function togglePause(){
    if(!running) return;
    running=false;
    els.startBtn.textContent = '‚ñ∂ –ü—Ä–æ–¥–æ–ª–∂–∏—Ç—å';
    els.status.textContent = '–ü–∞—É–∑–∞';
  }
  function resume(){
    if(running) return;
    running=true;
    // —Å–¥–≤–∏–Ω–µ–º t0, —á—Ç–æ–±—ã –≤—Ä–µ–º—è –ø—Ä–æ–¥–æ–ª–∂–∏–ª–æ—Å—å –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ
    const shown = parseFloat(els.time.textContent);
    t0 = performance.now() - shown*1000;
    els.startBtn.textContent = '‚è∏ –ü–∞—É–∑–∞';
    els.status.textContent = '–ü—Ä–æ–¥–æ–ª–∂–∞–π!';
  }

  function reset(){
    running=false;
    els.time.textContent = '0.0';
    els.done.textContent = '0';
    els.startBtn.textContent = '‚ñ∂ –°—Ç–∞—Ä—Ç';
    resetBoardVisual();
    buildSlots();
    buildPieces();
  }

  // --- UI bindings ---
  els.playBtn.addEventListener('click', start);
  els.startBtn.addEventListener('click', ()=>{
    if(els.overlay.style.display !== 'none') start();
    else if(!running && parseFloat(els.time.textContent) > 0) resume();
    else if(!running) start();
    else togglePause();
  });
  els.resetBtn.addEventListener('click', ()=>{
    els.overlay.style.display='none';
    reset();
  });
  els.sendBtn.addEventListener('click', ()=>sendResult(true));

  els.howBtn.addEventListener('click', ()=>{
    els.ovTitle.textContent = '–ö–∞–∫ –∏–≥—Ä–∞—Ç—å';
    els.ovText.innerHTML =
      `–ù–∞–∂–º–∏ <b>–°—Ç–∞—Ä—Ç</b>.<br>
       –ü–µ—Ä–µ—Ç–∞—Å–∫–∏–≤–∞–π –¥–µ—Ç–∞–ª–∏ (SCREEN, CAM, BOARD, BAT, SPK, TAPTIC) –≤ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—â–∏–µ ‚Äú—Å–ª–æ—Ç—ã‚Äù –≤–Ω—É—Ç—Ä–∏ –∫–æ–Ω—Ç—É—Ä–∞.<br>
       –ï—Å–ª–∏ –¥–µ—Ç–∞–ª—å –±–ª–∏–∑–∫–æ –∫ –º–µ—Å—Ç—É ‚Äî –æ–Ω–∞ <b>–ø—Ä–∏–ª–∏–ø–Ω–µ—Ç</b>. –°–æ–±–µ—Ä–∏ –≤—Å–µ 6 –±—ã—Å—Ç—Ä–µ–µ!`;
  });

  // Space = —Å—Ç–∞—Ä—Ç/–ø–∞—É–∑–∞/–ø—Ä–æ–¥–æ–ª–∂–∏—Ç—å
  window.addEventListener('keydown', (e)=>{
    if(e.code==='Space'){
      e.preventDefault();
      if(els.overlay.style.display !== 'none') start();
      else if(!running && parseFloat(els.time.textContent) > 0) resume();
      else if(!running) start();
      else togglePause();
    }
  });

  // initial
  reset();

})();
</script>
</body>
</html>
