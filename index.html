// server.js
const express = require('express');
const cors = require('cors');
const app = express();

app.use(cors());
app.use(express.json());

const players = new Map(); 
// key: username, value: { username, bestScore, totalScore, gamesCount, updatedAt }

// POST /api/score  -> сохранить результат
app.post('/api/score', (req, res) => {
  const { username, score } = req.body || {};
  if (!username || typeof score !== 'number') {
    return res.status(400).json({ error: 'username and score required' });
  }

  const cleanUsername = String(username).trim().replace(/^@/, '');
  if (!cleanUsername) {
    return res.status(400).json({ error: 'bad username' });
  }

  const s = Math.max(0, Math.floor(score));

  let player = players.get(cleanUsername);
  if (!player) {
    player = {
      username: cleanUsername,
      bestScore: s,
      totalScore: s,
      gamesCount: 1,
      updatedAt: new Date()
    };
  } else {
    player.bestScore = Math.max(player.bestScore, s);
    player.totalScore += s;
    player.gamesCount += 1;
    player.updatedAt = new Date();
  }

  players.set(cleanUsername, player);

  res.json({ ok: true, player });
});

// GET /api/leaderboard?limit=10&type=best|total
app.get('/api/leaderboard', (req, res) => {
  const limit = parseInt(req.query.limit || '10', 10);
  const type = req.query.type === 'total' ? 'total' : 'best';

  let arr = Array.from(players.values());

  if (type === 'total') {
    arr.sort((a, b) => b.totalScore - a.totalScore);
  } else {
    arr.sort((a, b) => b.bestScore - a.bestScore);
  }

  arr = arr.slice(0, Math.max(1, limit));

  res.json(arr.map(p => ({
    username: p.username,
    bestScore: p.bestScore,
    totalScore: p.totalScore,
    gamesCount: p.gamesCount
  })));
});

const PORT = process.env.PORT || 3000;
app.listen(PORT, () => {
  console.log('SHEEPLY leaderboard server running on port', PORT);
});

